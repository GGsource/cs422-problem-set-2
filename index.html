<!--
CandyCrush
Your Name: Geo Gonzalez
Collaborators: None.
-->
<!DOCTYPE html>
<html lang="en">
  <!--
/* Copyright (c) 2017 MIT 6.813/6.831 course staff, all rights reserved.
 * Redistribution of original or derived work requires permission of course staff.
 */
-->

  <head>
    <meta charset="utf-8" />
    <title>CandyCrush</title>

    <!-- Load style sheets -->
    <link
      rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/css/bootstrap.css"
    />

    <link rel="stylesheet" href="mainLayout.css" />

    <!-- Use mobile-aware viewport -->
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />

    <!-- Load any supplemental Javascript libraries here -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/seedrandom/2.4.2/seedrandom.js"></script>
    <script src="candy.js"></script>
    <script src="board.js"></script>
    <script src="rules.js"></script>
    <script src="utilities.js"></script>
    <script>
      // By default, the first board loaded by your page will be the same
      // each time you load (which is accomplished by "seeding" the random
      // number generator. This makes testing (and grading!) easier!
      Math.seedrandom(0);

      // A short jQuery extension to read query parameters from the URL.
      $.extend({
        getUrlVars: function () {
          var vars = [],
            pair;
          var pairs = window.location.search.substr(1).split("&");
          for (var i = 0; i < pairs.length; i++) {
            pair = pairs[i].split("=");
            vars.push(pair[0]);
            vars[pair[0]] =
              pair[1] && decodeURIComponent(pair[1].replace(/\+/g, " "));
          }
          return vars;
        },
        getUrlVar: function (name) {
          return $.getUrlVars()[name];
        },
      });

      // constants
      var DEFAULT_BOARD_SIZE = 8;

      // data model at global scope for easier debugging
      var board;
      var rules;

      // initialize board
      if ($.getUrlVar("size") && $.getUrlVar("size") >= 3) {
        board = new Board($.getUrlVar("size"));
      } else {
        board = new Board(DEFAULT_BOARD_SIZE);
      }

      // load a rule
      rules = new Rules(board);

      // Final initialization entry point: the Javascript code inside this block
      // runs at the end of start-up when the page has finished loading.
      $(document).ready(function () {
        rules.prepareNewGame();
        createGuiBoard(board);
        // Values needed for other functions
        gameTable = document.getElementById("gameTable");
        moveButtons = [
          document.getElementById("moveUp"),
          document.getElementById("moveLeft"),
          document.getElementById("moveRight"),
          document.getElementById("moveDown"),
        ];
        moveInput = document.getElementById("moveInput");
      });

      /* Event Handlers */
      // access the candy object with info.candy

      // add a candy to the board
      $(board).on("add", function (e, info) {
        // TESTME: Not sure what functionality is needed here
        console.log("add event triggered");
        // refreshGuiBoard();
      });

      // move a candy on the board
      $(board).on("move", function (e, info) {
        // TESTME: Seems to work.
        console.log("move event triggered");
        refreshGuiBoard();
      });

      // remove a candy from the board
      $(board).on("remove", function (e, info) {
        // TODO: Your code here.
        console.log("remove event triggered but not yet implemented üòî");
      });

      // move a candy on the board
      $(board).on("scoreUpdate", function (e, info) {
        // TODO: Your code here. To be implemented in pset 2.
        console.log("scoreUpdate even triggered but not yet implemented üòî");
      });

      // DONE: Behavior for new game button
      $(document).on("click", "#newGameButton", function (evt) {
        // FIXME: The new board is NOT valid, it contains crushes upon creation.
        board.clear();
        rules.prepareNewGame();
        refreshGuiBoard();
        // console.log("new game prepared");
      });

      // DONE: When crush button is pressed crush
      $(document).on("click", "#crushBtn", async function () {
        toDestroy = rules.getCandyCrushes();
        rules.removeCrushes(toDestroy);
        console.log(
          "Successfully crushed with " + toDestroy.length + " crushes"
        );
        refreshGuiBoard();
        await delay(1000); //FIXME: Should disable crush button during this wait!
        rules.moveCandiesDown();
        refreshGuiBoard();
        // Now that we've crushed once, check if there are more crushes needed, if not then disable crushing
        if (rules.getCandyCrushes().length <= 0) {
          toggleCrush();
          //TODO: Once returned to inputting, should clear field and put cursor there
          enableAndFocusInput();
        }
      });

      // DONE: Whenever an arrow button is pressed it checks which one was pressed and moves accordingly
      $(document).on(
        "click",
        "#moveUp, #moveLeft, #moveRight, #moveDown",
        function () {
          let pressedBtnText = $(this).text().trim();
          console.log(pressedBtnText + " was pressed");
          let destCandy;
          switch (pressedBtnText) {
            case "‚Üë":
              destCandy = board.getCandyInDirection(candyInput, "up");
              break;
            case "‚Üê":
              destCandy = board.getCandyInDirection(candyInput, "left");
              break;
            case "‚Üí":
              destCandy = board.getCandyInDirection(candyInput, "right");
              break;
            case "‚Üì":
              destCandy = board.getCandyInDirection(candyInput, "down");
              break;
            default:
              console.log("uh oh. Received " + pressedBtnText);
          }
          board.flipCandies(candyInput, destCandy);
          //Now that the candies have been flipped, we don't want the user to move anything else or enter any new location until they crush the existing candies
          disableInput();
          toggleCrush();
        }
      );

      // DONE: Checks for valid input every time user types something into input field
      $(document).on("keyup", "#moveInput", function () {
        checkValidDirections();
      });
    </script>
  </head>

  <body>
    <div class="container-fluid">
      <div class="row">
        <div class="col-md-3" id="firstColumn" align="center">
          <div id="title">Candy<br />Crush</div>
          <button id="newGameButton" type="button" class="btn btn-info">
            New Game
          </button>
        </div>

        <div class="col-md-6" id="mainColumn" align="center">
          <table id="gameTable"></table>
        </div>

        <div class="col-md-3" id="lastColumn" align="center">
          <!-- Move Label -->
          <div class="row rightRow">
            <div class="col-md" id="inputColumn" align="center">
              <label for="moveField">Move:</label>
              <input type="text" name="moveField" id="moveInput" />
            </div>
          </div>
          <!-- Top Row -->
          <div class="row rightRow" id="upBtnRow">
            <!-- Top Left Column -->
            <div class="col-md btnColumn" align="center"></div>
            <!-- Top Center Column -->
            <div class="col-md btnColumn" align="center">
              <button
                type="button"
                class="btn btn-danger"
                id="moveUp"
                disabled="disabled"
              >
                ‚Üë
              </button>
            </div>
            <!-- Top Right Column -->
            <div class="col-md btnColumn" align="center"></div>
          </div>
          <!-- Center Row -->
          <div class="row rightRow" id="horizontalBtnRow">
            <!-- Center Left Column -->
            <div class="col-md btnColumn" align="center">
              <button
                type="button"
                class="btn btn-danger"
                id="moveLeft"
                disabled="disabled"
              >
                ‚Üê
              </button>
            </div>
            <!-- Center Center Column -->
            <div class="col-md btnColumn" align="center"></div>
            <!-- Center Right Column -->
            <div class="col-md btnColumn" align="center">
              <button
                type="button"
                class="btn btn-danger"
                id="moveRight"
                disabled="disabled"
              >
                ‚Üí
              </button>
            </div>
          </div>
          <!-- Bottom Row -->
          <div class="row rightRow" id="downBtnRow">
            <!-- Bottom Left Column -->
            <div class="col-md btnColumn" align="center"></div>
            <!-- Bottom Center Column -->
            <div class="col-md" align="center">
              <button
                type="button"
                class="btn btn-danger"
                id="moveDown"
                disabled="disabled"
              >
                ‚Üì
              </button>
            </div>
            <!-- Bottom Right Column -->
            <div class="col-md btnColumn" align="center"></div>
          </div>
          <button
            type="button"
            class="btn btn-info"
            id="crushBtn"
            disabled="disabled"
          >
            Crush Once
          </button>
        </div>
      </div>
      <!-- class="row" -->
    </div>
    <!-- class="container" -->
  </body>
</html>
